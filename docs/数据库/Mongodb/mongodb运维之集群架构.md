---
tags: 学习/运维技术/数据库/mongodb
---

## 目录
* 1. Mongodb的集群模式简介
    * 主从复制
    * 副本集
    * 分片模式
* 2. 集群模式的搭建 && 工作原理

## Mongodb的集群模式
Mongodb共有三种集群模式，分别是`主从复制`，`副本集`，`分片模式`

## 主从复制
目前已经不推荐使用，这里只做简单的介绍
![](https://gitee.com/animezjy/PicGo_img/raw/master/images/202203251635207.png)

在主从复制结构中，只能有一个主节点，主节点提供所有的*增、删、改、查*服务，从节点只做备份使用。也可以通过一些配置使得从节点可读，减轻主节点的压力。
主节点会把每次的操作记录到oplog中，从节点定期轮询主节点获取这些操作，然后在自己的节点上执行，保证从节点和主节点的数据一致性。

当主节点出现故障时，只能手动指定新主节点，在出现故障的时间内，集群一直处于只读状态

## 副本集
![](https://gitee.com/animezjy/PicGo_img/raw/master/images/202203251655195.png)
副本集模式下，集群有一个主节点和多个从节点，主节点负责的工作与主从模式类似，两者区别在于：*主节点发生故障时，副本集可以自动投票，选择出新的主节点，其他所有从节点会连接新的主节点。在这个过程中，用户是无感知的*
> 副本集模式就是带有自动故障转移的主从复制




## 分片




## 部署

### 副本集搭建
|ip|端口|功能
|:---:|:---:|:---:|
|172.16.111.21|27017|mongodb_primary（主节点）|
|172.16.111.22|27017|mongodb_secondary|
|172.16.111.11|27017|mongodb_arbiter|

```shell
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1604-4.2.8.tgz
tar -xf 
```






### 工作原理
主节点负责处理客户端的读写请求，备份节点负责映射主节点的数据。
备份节点定期轮询主节点上的数据操作，然后对自己的副本进行这些操作，从而保证数据的一致性。这些和主从复制模式是一致的

### oplog(operation log)
主节点上的**数据库状态改变**的操作会记录在oplog中。从节点会定期轮询主节点，将oplog同步到自己的节点上，并执行操作，达到数据一致的目的。


参考链接
[MongoDB oplog详解 - Joans - 博客园](https://www.cnblogs.com/joans/p/7723554.html)




