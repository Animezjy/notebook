# **进入Chroot并构建其他临时工具**



> 这一章手册内写的许多东西不是很理解，先抄过来，后面再补充注释



## **改变所有者**

将`$LFS`所有者改成root用户

```shell
chown -R root:root $LFS/{usr,lib,var,etc,bin,sbin,tools}
case $(uname -m) in
  x86_64) chown -R root:root $LFS/lib64 ;;
esac
```



> 以下的操作由root用户执行 

## **准备虚拟内核文件系统**

内核对外提供了一些文件系统，以便自己和用户空间进行通信。它们是虚拟文件系统，并不占用磁盘空间，其内容保留在内存中。

创建挂载点

```shell
mkdir -pv $LFS/{dev,proc,sys,run}
```



## **创建初始设备节点**

在内核引导系统时，它需要一些设备节点，特别是 `console` 和 `null` 两个设备。它们需要创建在硬盘上，这样在内核填充 `/dev` 前，或者 Linux 使用 *`init=/bin/bash`* 内核选项启动时，也能使用它们。运行以下命令创建它们

```shell
mknod -m 600 $LFS/dev/console c 5 1
mknod -m 666 $LFS/dev/null c 1 3
```



## 挂载和填充 /dev

用设备文件填充 `/dev` 目录的推荐方法是挂载一个虚拟文件系统 (例如 `tmpfs`) 到 `/dev`，然后在设备被发现或访问时动态地创建设备文件。这个工作通常由 Udev 在系统引导时完成。然而，我们的新系统还没有 Udev，也没有被引导过，因此必须手工挂载和填充 `/dev`。这可以通过绑定挂载宿主系统的 `/dev` 目录就实现。绑定挂载是一种特殊挂载类型，它允许在另外的位置创建某个目录或挂载点的映像。运行以下命令进行绑定挂载

```shell
mount -v --bind /dev $LFS/dev
```



## 挂载虚拟内核文件系统

挂载其余的虚拟内核文件系统

```
mount -v --bind /dev/pts $LFS/dev/pts
mount -vt proc proc $LFS/proc
mount -vt sysfs sysfs $LFS/sys
mount -vt tmpfs tmpfs $LFS/run
```

在某些宿主系统上，`/dev/shm` 是一个指向 `/run/shm` 的符号链接。我们已经在 /run 下挂载了 tmpfs 文件系统，因此在这里只需要创建一个目录。

```shell
if [ -h $LFS/dev/shm ]; then
  mkdir -pv $LFS/$(readlink $LFS/dev/shm)
fi
```



## **进入Chroot环境**

进入 chroot 环境并完成剩余临时工具的安装

```shell
chroot "$LFS" /usr/bin/env -i   \
    HOME=/root                  \
    TERM="$TERM"                \
    PS1='(lfs chroot) \u:\w\$ ' \
    PATH=/usr/bin:/usr/sbin \
    /bin/bash --login +h
```

![image-20220103144926839](https://gitee.com/animezjy/PicGo_img/raw/master/images/202201031449971.png)

使用`df -h`可以看到当前挂载的磁盘情况，可以看出这是一个临时环境

![image-20220103145030801](https://gitee.com/animezjy/PicGo_img/raw/master/images/202201031450905.png)



## **创建目录**



创建目录

```shell
mkdir -pv /{boot,home,mnt,opt,srv}
```

执行以下命令，为这些直接位于根目录中的目录创建次级目录结构

```shell
mkdir -pv /etc/{opt,sysconfig}
mkdir -pv /lib/firmware
mkdir -pv /media/{floppy,cdrom}
mkdir -pv /usr/{,local/}{include,src}
mkdir -pv /usr/local/{bin,lib,sbin}
mkdir -pv /usr/{,local/}share/{color,dict,doc,info,locale,man}
mkdir -pv /usr/{,local/}share/{misc,terminfo,zoneinfo}
mkdir -pv /usr/{,local/}share/man/man{1..8}
mkdir -pv /var/{cache,local,log,mail,opt,spool}
mkdir -pv /var/lib/{color,misc,locate}

ln -sfv /run /var/run
ln -sfv /run/lock /var/lock

install -dv -m 0750 /root
install -dv -m 1777 /tmp /var/tmp
```



## **创建必要的文件和符号链接**

Linux 在 `/etc/mtab` 维护已经挂载的文件系统的列表。现代内核在内部维护该列表，并通过 `/proc` 文件系统将它展示给用户。为了满足那些需要 `/etc/mtab` 的工具，执行以下命令，创建符号链接

```shell
ln -sv /proc/self/mounts /etc/mtab
```



创建一个`/etc/hosts`文件

```shell
cat > /etc/hosts << EOF
127.0.0.1  localhost $(hostname)
::1        localhost
EOF
```



创建`/etc/passwd`和`/etc/group`

```shell
cat > /etc/passwd << "EOF"
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/dev/null:/bin/false
daemon:x:6:6:Daemon User:/dev/null:/bin/false
messagebus:x:18:18:D-Bus Message Daemon User:/run/dbus:/bin/false
uuidd:x:80:80:UUID Generation Daemon User:/dev/null:/bin/false
nobody:x:99:99:Unprivileged User:/dev/null:/bin/false
EOF
```



```shell
cat > /etc/group << "EOF"
root:x:0:
bin:x:1:daemon
sys:x:2:
kmem:x:3:
tape:x:4:
tty:x:5:
daemon:x:6:
floppy:x:7:
disk:x:8:
lp:x:9:
dialout:x:10:
audio:x:11:
video:x:12:
utmp:x:13:
usb:x:14:
cdrom:x:15:
adm:x:16:
messagebus:x:18:
input:x:24:
mail:x:34:
kvm:x:61:
uuidd:x:80:
wheel:x:97:
nogroup:x:99:
users:x:999:
EOF
```

> 这里创建的用户组一部分是为了满足`Udev`规则的配置



后面的章节需要一个测试用的用户，现在把他创建出来

```shell
echo "tester:x:101:101::/home/tester:/bin/bash" >> /etc/passwd
echo "tester:x:101:" >> /etc/group
install -o tester -d /home/tester
```



移除"I have no name! "，新开一个shell登录

```shell
exec /bin/bash --login +h # 因为之前已经创建了 /etc/passwd 和 /etc/group 
```

![image-20220103145825507](https://gitee.com/animezjy/PicGo_img/raw/master/images/202201031458627.png)



**login**、**agetty** 和 **init** 等程序使用一些日志文件，以记录登录系统的用户和登录时间等信息。然而，这些程序不会创建不存在的日志文件。初始化日志文件，并为它们设置合适的访问权限

```shell
touch /var/log/{btmp,lastlog,faillog,wtmp}
chgrp -v utmp /var/log/lastlog
chmod -v 664  /var/log/lastlog
chmod -v 600  /var/log/btmp
```



## **GCC-11.2.0 中的 Libstdc++，第二遍**

在[交叉编译临时工具](装机/LFS/04-交叉编译临时工具)时，我们不得不暂缓安装 C++ 标准库，因为当时没有编译器能够编译它。我们不能使用那一节构建的编译器，因为它是一个本地编译器，不应在 chroot 外使用，否则可能导致编译产生的库被宿主系统组件污染



> 和之前一样 Libstdc++ 是 GCC 源代码的一部分。应该先解压 GCC 压缩包并切换到解压出来的 `gcc-11.2.0` 目录。



```shell
tar -xf gcc-11.2.0.tar.xz; cd gcc-11.2.0

# 创建一个符号链接，允许在 GCC 源码树中构建 Libstdc
ln -s gthr-posix.h libgcc/gthr-default.h

# 为 Libstdc++ 创建一个单独的构建目录，并切换到该目录
mkdir -v build
cd       build
```

编译安装

```shell
# 准备编译
../libstdc++-v3/configure            \
    CXXFLAGS="-g -O2 -D_GNU_SOURCE"  \
    --prefix=/usr                    \
    --disable-multilib               \
    --disable-nls                    \
    --host=$(uname -m)-lfs-linux-gnu \
    --disable-libstdcxx-pch

# 编译
make
# 安装
make install
```



## **Gettext-0.21**

Gettext 软件包包含国际化和本地化工具，它们允许程序在编译时加入 NLS (本地语言支持) 功能，使它们能够以用户的本地语言输出消息。



编译安装

```shell
tar -xf gettext-0.21.tar.xz; cd gettext-0.21
./configure --disable-shared
make

# 安装 msgfmt，msgmerge，以及 xgettext 这三个程序
cp -v gettext-tools/src/{msgfmt,msgmerge,xgettext} /usr/bin
```





## **Bison-3.7.6**

Bison 软件包包含语法分析器生成器



```shell
tar -xf bison-3.7.6.tar.xz; cd bison-3.7.6

./configure --prefix=/usr \
            --docdir=/usr/share/doc/bison-3.7.6
            
make
make install
```



## Perl-5.34.0



```shell

sh Configure -des                                        \
             -Dprefix=/usr                               \
             -Dvendorprefix=/usr                         \
             -Dprivlib=/usr/lib/perl5/5.34/core_perl     \
             -Darchlib=/usr/lib/perl5/5.34/core_perl     \
             -Dsitelib=/usr/lib/perl5/5.34/site_perl     \
             -Dsitearch=/usr/lib/perl5/5.34/site_perl    \
             -Dvendorlib=/usr/lib/perl5/5.34/vendor_perl \
             -Dvendorarch=/usr/lib/perl5/5.34/vendor_perl
make
make install
```



## **Python-3.9.6**



```shell
./configure --prefix=/usr   \
            --enable-shared \
            --without-ensurepip
make
make install
```





```shell
sed -e 's/__attribute_nonnull__/__nonnull/' \
    -i gnulib/lib/malloc/dynarray-skeleton.c
    

./configure --prefix=/usr

make
make install

```



## **util-linux-2.37.2**



```shell
./configure ADJTIME_PATH=/var/lib/hwclock/adjtime    \
            --libdir=/usr/lib    \
            --docdir=/usr/share/doc/util-linux-2.37.2 \
            --disable-chfn-chsh  \
            --disable-login      \
            --disable-nologin    \
            --disable-su         \
            --disable-setpriv    \
            --disable-runuser    \
            --disable-pylibmount \
            --disable-static     \
            --without-python     \
            runstatedir=/run
make
make install
```



## **清理和备份临时系统**



